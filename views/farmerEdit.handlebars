<h3 class="title">
    Edit Your Profile Below</h3>
<div class="container farmer-info-basic">
    <div class="vendor-profile-basic row">
        <div class="col s5">
            <div class="vendor-profile-basic-intro">
                <img id="vendorPhoto" class="vendor-profile-basic-intro-pic" src="http://www.yourdictionary.com/images/definitions/lg/4320.farmer.jpg" alt="profile-image"
                /> 
                <input type='file' id='fileButtonVendor'>
                <div class="vendor-profile-basic-name">
                    <textarea id="vendor-name" class="materialize-textarea">Vendor Name</textarea>
                </div>
            </div>
        </div>
        <div class="col s7">
            <div class="vendor-profile-basic-more">
                <div class="vendor-profile-basic-about">Bio
                    <div class="input-field ">
                        <textarea id="vendor-bio" class="materialize-textarea"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Product Section --->
    <div class="vendor-product row">
        <div class="col s7 current-product box">
            Crops
            <div class="product-card">
                <div class="card-body">
                    <textarea placeholder="Sweet Potatoes" id="vendor-crop" class="materialize-textarea"></textarea>
                </div>
            </div>
            <button id="crops-edit-btn" class="button button-rounded-hover">Submit Crops Edits</button>

        </div>
        <div class="col s7 current-product box">
            Livestock
            <div class="product-card">
                <div class="card-body">
                    <textarea placeholder="Dairy Cows" id="vendor-livestock" class="materialize-textarea"></textarea>
                </div>
            </div>
            <button id="livestock-edit-btn" class="button button-rounded-hover">Submit Livestock Edits</button>

        </div>
        <div class="col s1"></div>
        <div class="col s4 contact-info box">
            Contact info
            <div class="product-card">
                <div class="card-body">
                    Phone:
                    <textarea id="vendor-phone" class="materialize-textarea"> 777-777-7777</textarea> 
                    Email:
                    <textarea id="vendor-email" class="materialize-textarea"> connorgreed@gmail.com</textarea>
                    Street Address:
                    <textarea id="vendor-address" class="materialize-textarea"> </textarea>
                    City:
                    <textarea id="vendor-city" class="materialize-textarea"> </textarea>
                    State:
                    <textarea id="vendor-state" class="materialize-textarea"> </textarea>
                    Zip:
                    <textarea id="vendor-zip" class="materialize-textarea"> </textarea>
                </div>
            </div>
        </div>
    </div>
    <div class="vendor-footer row">
        <div class="col-md-12">
            <footer>
<button id="farmer-edit-btn" class="button button-rounded-hover">Submit Info Edits</button>
            </footer>
        </div>
    </div>
</div>



<script>
    $("[data-menu-underline-from-center] a").addClass("underline-from-center");

    $(document).ready(() => {

        firebase.auth().onAuthStateChanged( user => {
            displayPic();
            displayVendor();
        });        

        $('#farmer-edit-btn').on('click', e => {
            e.preventDefault();

            let uid = firebase.auth().currentUser.uid;
            let bio = $('#vendor-bio').val().trim();
            let vendorName = $('#vendor-name').val().trim();
            let phoneNum = $('#vendor-phone').val().trim();
            let email = $('#vendor-email').val().trim();
            let address = $('#vendor-address').val().trim();
            let city = $('#vendor-city').val().trim();
            let state = $('#vendor-state').val().trim();
            let zip = $('#vendor-zip').val().trim();
            validateForm = () => {
                let isValid = true;
                if (bio === '' || vendorName === '' || phoneNum === '' || email === '' || 
                address === '' || city === '' || state === '' || zip === '') {
                    alert('Please input all Vendor Information.');
                    isValid = false;
                }
                return isValid;
            }
            if(!validateForm()) {
                return;
            };

            $.post('/api/vendorEdit', {
                uid,
                bio,
                vendorName,
                phoneNum,
                email,
                address,
                city,
                state,
                zip
            });            
            // TODO: use reg expression to validate email format
        });

        $('#crops-edit-btn').on('click', e => {
            e.preventDefault();

            let uid = firebase.auth().currentUser.uid;
            let crop = $('#vendor-crop').val().trim();
            validateForm = () => {
                let isValid = true;
                if (crop === '') {
                    alert('Please input a crop to add.');
                    isValid = false;
                }
                return isValid;
            }
            if(!validateForm()) {
                return;
            };
            $.post('/api/vendorEdit/Crop', {
                uid,
                crop
            });
            $('#vendor-crop').text('');
        });

        $('#livestock-edit-btn').on('click', e => {
            e.preventDefault();

            let uid = firebase.auth().currentUser.uid;
            let livestock = $('#vendor-livestock').val().trim();
            validateForm = () => {
                let isValid = true;
                if (livestock === '') {
                    alert('Please input a livestock to add.');
                    isValid = false;
                }
                return isValid;
            }
            if(!validateForm()) {
                return;
            };
            $.post('/api/vendorEdit/Livestock', {
                uid,
                livestock
            });
            $('#vendor-livestock').text('');
        });


        const imageButton = document.getElementById('fileButtonVendor');
        // Listen for file selection
        imageButton.addEventListener('change', e => {
            // Get file
            let file = e.target.files[0];
            // Create a storage ref
            let storageRef = firebase.storage().ref('vendor_photo/' + firebase.auth().currentUser.uid);
            // substitute file.name with uid
            // Upload file then use promise to display pic
            storageRef.put(file).then(snap => {
                displayPic();
            });
        });

        // use url of image uploaded by user to display profile picture
        displayPic = () => {
            firebase.storage().ref('vendor_photo/' + firebase.auth().currentUser.uid).getDownloadURL().then(url => {
                console.log(url);
                let uid = firebase.auth().currentUser.uid;
                $.post('/api/vendorEdit/photo', {
                    uid,
                    url
                });

                // insert url into image src
                let img = document.getElementById('vendorPhoto');
                img.src = url;
            }).catch(function (error) {
                // Handle any errors
                console.log('Error: ', error);
            });
        };

        displayVendor = () => {
            let userId = firebase.auth().currentUser.uid;
            let base = location.origin;
            $.get(base + '/api/vendors/uid/' + userId, result => {
                $('#vendor-bio').text(result.Bio);
                $('#vendor-name').text(result.Vendor);
                $('#vendor-phone').text(result.Phone);
                $('#vendor-email').text(result.Email);
                $('#vendor-address').text(result.Address);
                $('#vendor-city').text(result.City);
                $('#vendor-state').text(result.State);
                $('#vendor-zip').text(result.Zip);
            });
        };
    });
</script>